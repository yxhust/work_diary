

## ch2 数据指标体系

### 总览
1. 基于用户维度(userid)的用户标签体系
2. 基于用户使用设备维度(cookie_id)的标签体系
> 当用户没有登录账号却访问设备时，可以基于用户在设备上的行为对该设备推送广告、产品和服务。

### 用户属性维度
> 建好用户属性维度标签，再进行打标签。


 ==逻辑应该是这样：先确定标签主题，继而按标签主题展开成多个一级归类，每个一级归类下有多个标签名称，获得标签名称是何种方式即为标签类型==

| 标签名称 | 标签主题 | 一级归类 | 标签类型 |
| :---: | :---: | :---: | :---: |
| 男 | 用户属性 | 自然性别 | 统计 |
| 女 | 用户属性 | 购物性别 | 规则 |

`标签关系，可互斥或不互斥，如标签男标签女互斥`

1. 统计类标签
- 一级归类即为常说的维度分类，与标签名称是一对多的关系，与标签主题多对一的关系

| 标签名称 | 标签主题 | 一级归类 | 标签类型 |
| :---: | :---: | :---: | :---: |
| 钻石会员 | 用户属性 | 会员类型 | 统计 |
| 白金会员 | 用户属性 | 会员类型 | 统计 |
| 黄金会员 | 用户属性 | 会员类型 | 统计 |
| 白银会员 | 用户属性 | 会员类型 | 统计 |
| 黄铜会员 | 用户属性 | 会员类型 | 统计 |


2. 规则类标签
`依靠数据调研结果制定科学的规则`

| 标签名称 | 标签主题 | 一级归类 | 标签类型 |
| :---: | :---: | :---: | :---: |
| 高活跃度 | 用户属性 | 用户活跃度 | 规则 |
| 中活跃度 | 用户属性 | 用户活跃度 | 规则 |
| 低活跃度 | 用户属性 | 用户活跃度 | 规则 |
| 新用户 | 用户属性 | 用户活跃度 | 规则 |
| 流失用户 | 用户属性 | 用户活跃度 | 规则 |

3. 机器学习挖掘类标签

### 用户行为维度


| 标签名称 | 标签主题 | 一级归类 | 标签类型 |
| :---: | :---: | :---: | :---: |
| 近x日访问次数 | 用户行为 | 近x日行为 | 统计 |
| 近x日客单价 | 用户行为 | 近x日行为 | 统计 |
| 近x日活跃天数 | 用户行为 | 近x日行为 | 统计 |
| 近x日访问时长 | 用户行为 | 近x日行为 | 统计 |
| 高频用户 | 用户行为 | 购买频度 | 规则 |
| 土豪用户 | 用户行为 | 消费充值 | 规则 |


### 用户消费维度

### 风险控制维度

### 社交属性维度


## ch3 标签数据存储
> 存储方式的技术选型，取决于应用场景。主要介绍hive、mysql、hbase、elasticsearch的应用场景和解决方案。

### hive存储
- hive数仓
1. hive数仓，用于存储用户标签数据。
- 数仓特点：
  - 面向主题的（如用户主题、订单主题、社群主题等）
  - 集成的（从业务数据库到ods层，经etl清洗）
  - 非易失的（主要指使用规则上，不能修改删除）
  - 随时间变化（数据带有时间属性）
- 数仓开发：
  - 事实表：围绕业务过程设计，
  - 维度表：对事实属性的各个方面描述
  
2. 分区存储
- 分表存储
  - 人口属性表：
  - 行为属性表：
  - 用户消费表：
  - 风险控制表：
  - 社交属性表：
  - 在开发标签宽表时，为提高插入和查询效率，hive中使用分区表。在建表时引入partition，查询时通过hive的分区机制来控制一次遍历的数据量。
  
3. 标签汇聚
- 背景：由于hive分区存储标签，一个用户的标签会插入到不同分区里面。为方便分析和查询，将用户的标签做聚合处理。
- 方式：使用udf函数对存储用户标签的各个表中数据进行聚合，最终用户各个标签汇聚成json字符串格式。
- 目的：便于查询。在用户画像产品中，输入用户id查询，可在前端展示该用户的各个标签，如用户属性、用户行为等。

4. ID-MAP
- 背景：把用户不同来源的身份标识通过数据手段识别为同一主体。
- 场景：用户未登录app状态下，行为数据是设备id（cookieid）记录的；用户登录app后，行为数据是账号id（userid）记录的。虽然是同一个用户，但cookieid和userid数据是未打通的。
- 目的：通过ID-MAP打通cookieid和userid，可以获取用户登录和未登录的数据。
- 我的经历：当前公司的同一业务数据，同一用户在不同平台（神策埋点、mysql）不一样，在不同产品下也可能不同。

- 解决示例：
```
埋点日志表 ods.page_event_log
访问日志表 ods.page_view_log
```

### MySQL存储
1. 元数据管理
hive适用于大数据量的批处理作业，对于量级较小的数据，MySQL有更快的读写速度。因此，MySQL数据库方便标签元数据的编辑、查询、管理。

元数据录入
元数据查询
元数据表结构设计

2. 监控预警数据
MySQL存储每天对etl结果的监控信息。从画像调度流关键节点看：
- 标签计算数据监控
监控每天标签etl的数据量是否出现异常
- 服务层同步数据监控
服务层一般采用HBase、elasticsearch作为数据库存储标签数据供线上调用，将标签相关数据从hive数仓想服务层同步的过程中，需要记录相关数据在hive中的数量及同步到服务层的数量，若数量不一致则触发出错告警。

在对画像的数据监控中，调度流每跑完相应的模块，就将该模块的监控数据插入MySQL，进行校验任务判断。

3. 结果集存储
打通画像数据与线上业务系统时，考虑将存储在hive中的用户标签数据同步到各业务系统中，此时MySQL可用于存储结果集。结果集存储 用于多为透视分析的标签

Sqoop支持Hadoop和关系型数据库两者数据的相互迁移。








  







